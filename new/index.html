<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿å¯§æ ¡åœ’å®ˆè­·è€… - å‹‡è€…æ”»åŸç¯‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@500;700;900&display=swap');

        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        .pixel-font {
            font-family: 'Press Start 2P', monospace;
        }

        #game-canvas {
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* --- Start Screen Theme: Hero Siege --- */
        .siege-bg {
            background: radial-gradient(circle at 50% 30%, #2e1065 0%, #000000 90%);
            overflow: hidden;
        }
        
        .castle-silhouette {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background-image: linear-gradient(to top, #000 0%, #1a0b2e 100%);
            clip-path: polygon(
                0% 100%, 0% 40%, 10% 40%, 10% 20%, 15% 20%, 15% 40%, /* Tower 1 */
                25% 40%, 25% 60%, 35% 60%, 35% 30%, 45% 30%, 45% 60%, /* Main Gate */
                55% 60%, 55% 30%, 65% 30%, 65% 60%, 
                75% 60%, 85% 60%, 85% 20%, 90% 20%, 90% 40%, 100% 40%, 100% 100% /* Tower 2 */
            );
            z-index: -1;
            opacity: 0.8;
        }

        .fire-particle {
            position: absolute;
            bottom: 0;
            width: 4px;
            height: 4px;
            background: #ef4444;
            box-shadow: 0 0 10px #f59e0b;
            border-radius: 50%;
            animation: rise 3s infinite linear;
            opacity: 0;
        }

        @keyframes rise {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-300px) scale(0); opacity: 0; }
        }

        .hero-title {
            background: linear-gradient(to bottom, #facc15, #b45309);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 0 #78350f);
        }

        .rpg-btn {
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            border: 4px solid #1e3a8a;
            box-shadow: 0 6px 0 #1e3a8a, 0 10px 10px rgba(0,0,0,0.5);
            transition: all 0.1s;
        }
        .rpg-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #1e3a8a, inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* --- Game Elements --- */
        .card {
            transition: transform 0.2s, border-color 0.2s;
            cursor: pointer;
            pointer-events: auto;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }
        .card:hover {
            transform: translateY(-10px);
            border-color: #facc15;
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .damage-text {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            color: #ff4444;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 2px 2px 0 #000;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex justify-center items-center select-none bg-black">

    <!-- Canvas Layer -->
    <canvas id="game-canvas"></canvas>

    <!-- UI Overlay: Start Screen (Hero Siege Theme) -->
    <div id="start-screen" class="ui-layer siege-bg z-50 pointer-events-auto">
        <!-- Castle Silhouette -->
        <div class="castle-silhouette"></div>
        
        <!-- Fire Particles Container (Populated via JS) -->
        <div id="fire-container" class="absolute w-full h-full pointer-events-none"></div>

        <div class="relative z-10 text-center flex flex-col items-center">
            <div class="mb-2 text-yellow-500 font-bold tracking-[0.5em] text-sm uppercase">Typing RPG</div>
            <h1 class="text-5xl md:text-7xl mb-6 pixel-font hero-title leading-tight">
                è¥¿å¯§<br>æ ¡åœ’å®ˆè­·è€…
            </h1>
            
            <div class="bg-black/50 p-6 rounded-lg backdrop-blur-sm border border-white/10 mb-8 max-w-md">
                <p class="text-gray-200 mb-2 text-lg font-bold">å‹‡è€…å¬é›†ä»¤ï¼</p>
                <p class="text-gray-400 text-sm">é­”ç‰©æ­£åœ¨é€²æ”»åšå­¸ã€ç¾¤è‹±èˆ‡è€•å¿ƒæ¨“ã€‚<br>å”¯æœ‰ç²¾æº–çš„éµç›¤æ“ä½œèƒ½æ“Šé€€å®ƒå€‘ã€‚</p>
                <p class="text-red-400 text-sm mt-2 font-bold animate-pulse">æ³¨æ„ï¼šæ‰“éŒ¯å­—æœƒå—åˆ°åå™¬å‚·å®³ï¼</p>
            </div>

            <button onclick="startGame()" class="rpg-btn px-10 py-5 text-white font-bold rounded pixel-font text-xl flex items-center gap-3">
                <span>âš”ï¸</span> é–‹å§‹å¾æˆ°
            </button>
        </div>
        
        <div class="absolute bottom-4 text-xs text-gray-600">
            æŒ‰éµå³æ”»æ“Š â€¢ å®ˆè­·æ ¡åœ’
        </div>
    </div>

    <!-- UI Overlay: HUD -->
    <div id="hud" class="ui-layer !justify-between !items-start p-4 hidden">
        <div class="flex justify-between w-full max-w-5xl mx-auto items-end bg-black/30 p-2 rounded-xl backdrop-blur-sm border border-white/10">
            <!-- HP Bar -->
            <div class="flex flex-col gap-1 w-1/3">
                <div class="flex justify-between">
                    <div class="text-red-400 pixel-font text-xs">HP</div>
                    <div id="hp-text" class="text-white text-xs font-mono">100/100</div>
                </div>
                <div class="w-full h-6 bg-gray-900 border-2 border-gray-600 rounded relative overflow-hidden">
                    <div id="hp-bar" class="h-full bg-gradient-to-r from-red-800 to-red-500 transition-all duration-300" style="width: 100%;"></div>
                </div>
            </div>
            
            <!-- Stage Info -->
            <div class="text-center absolute left-1/2 -translate-x-1/2 top-4">
                <div id="stage-name" class="text-2xl font-bold text-yellow-300 tracking-widest drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">è¥¿å¯§åšå­¸æ¨“</div>
                <div class="text-xs text-gray-400 mt-1 bg-black/50 px-2 rounded">é€²åº¦: <span id="progress-text">0%</span></div>
            </div>

            <!-- Score -->
            <div class="text-right w-1/3">
                <div class="text-blue-400 pixel-font text-xs">SCORE</div>
                <div id="score-display" class="text-3xl font-bold pixel-font text-white drop-shadow-md">0</div>
            </div>
        </div>
        
        <!-- Level Up Notification -->
        <div id="level-notify" class="absolute top-1/3 w-full text-center hidden z-50">
            <h2 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-[0_5px_0_#000] animate-bounce pixel-font">
                VICTORY!
            </h2>
            <p class="text-white text-xl mt-2 font-bold drop-shadow-md">æº–å‚™é€²å…¥ä¸‹ä¸€å±¤...</p>
        </div>
    </div>

    <!-- UI Overlay: Upgrade Menu -->
    <div id="upgrade-menu" class="ui-layer bg-black/95 z-40 hidden pointer-events-auto backdrop-blur">
        <h2 class="text-4xl text-yellow-500 mb-2 font-bold pixel-font">æˆ°åˆ©å“é¸æ“‡</h2>
        <p class="text-gray-400 mb-10">é¸æ“‡ä¸€ç¨®èƒ½åŠ›å¼·åŒ–ä½ çš„è‹±é›„...</p>
        
        <div id="cards-container" class="flex flex-col md:flex-row gap-6 p-4">
            <!-- Cards will be injected here via JS -->
        </div>
    </div>

    <!-- UI Overlay: Game Over -->
    <div id="game-over-screen" class="ui-layer bg-red-950/95 z-50 hidden pointer-events-auto">
        <h1 class="text-6xl text-red-500 mb-4 pixel-font drop-shadow-[0_4px_0_#000]">DEFEATED</h1>
        <p class="text-xl text-gray-300 mb-2">æœ€çµ‚å¾—åˆ†</p>
        <p id="final-score" class="text-5xl text-yellow-400 mb-8 pixel-font">0</p>
        <p id="death-reason" class="text-red-300 mb-8 font-bold text-lg border-b border-red-800 pb-2">æ ¡åœ’å¤±å®ˆäº†...</p>
        <button onclick="location.reload()" class="rpg-btn px-8 py-4 text-white font-bold rounded pixel-font hover:brightness-110 transition">
            ğŸ”„ é‡æ–°æŒ‘æˆ°
        </button>
    </div>

    <!-- UI Overlay: Victory -->
    <div id="victory-screen" class="ui-layer bg-yellow-900/95 z-50 hidden pointer-events-auto">
        <h1 class="text-5xl text-yellow-400 mb-4 pixel-font drop-shadow-[0_4px_0_#000]">LEGENDARY!</h1>
        <p class="text-xl text-gray-100 mb-4">ä½ æˆåŠŸå®ˆè­·äº†è¥¿å¯§æ ¡åœ’ï¼</p>
        <p class="text-6xl mb-8">ğŸ†</p>
        <p class="text-lg text-gray-300">æœ€çµ‚å¾—åˆ†</p>
        <p id="victory-score" class="text-4xl text-white mb-8 pixel-font">0</p>
        <button onclick="location.reload()" class="rpg-btn px-8 py-4 text-white font-bold rounded pixel-font hover:brightness-110 transition">
            ğŸ‘‘ å†æ¬¡æŒ‘æˆ°
        </button>
    </div>

    <script>
        // --- Visual Effects for Start Screen ---
        function initStartScreenEffects() {
            const container = document.getElementById('fire-container');
            // Create fire particles
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.className = 'fire-particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (2 + Math.random() * 3) + 's';
                p.style.animationDelay = (Math.random() * 2) + 's';
                container.appendChild(p);
            }
        }
        initStartScreenEffects();

        // --- Audio System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'shoot') {
                // Laser/Sword sound
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } else if (type === 'miss') {
                // Error buzz
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'powerup') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'damage') {
                osc.type = 'lowshelf'; // simulated with triangle
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- Game Config & State ---
        const LEVELS = [
            { 
                name: "ç¬¬ä¸€é—œï¼šè¥¿å¯§åšå­¸æ¨“", 
                chars: "ASDFGHJKL", 
                desc: "ä¸­æ’éµä½ - éª·é«å…µå…¥ä¾µ",
                color: "#3b82f6", // Blue
                enemySpeedBase: 1.5,
                spawnRate: 1200,
                targetKills: 20
            },
            { 
                name: "ç¬¬äºŒé—œï¼šè¥¿å¯§ç¾¤è‹±æ¨“", 
                chars: "QWERTYUIOP", 
                desc: "ä¸Šæ’éµä½ - è™è ä¾†è¥²",
                color: "#ef4444", // Red
                enemySpeedBase: 1.8,
                spawnRate: 1000,
                targetKills: 25
            },
            { 
                name: "ç¬¬ä¸‰é—œï¼šè¥¿å¯§è€•å¿ƒæ¨“", 
                chars: "ZXCVBNM", 
                desc: "ä¸‹æ’éµä½ - å²èŠå§†çªæ“Š",
                color: "#22c55e", // Green
                enemySpeedBase: 2.0,
                spawnRate: 900,
                targetKills: 25
            },
            { 
                name: "é­”ç‹é—œå¡ï¼šå…¨æ ¡å®ˆè­·æˆ°", 
                chars: "ABCDEFGHIJKLMNOPQRSTUVWXYZ", 
                desc: "å…¨è»å‡ºæ“Š - æœ€çµ‚æ±ºæˆ°",
                color: "#a855f7", // Purple
                enemySpeedBase: 2.5,
                spawnRate: 600,
                targetKills: 50,
                isBoss: true
            }
        ];

        const BUFFS = [
            { id: 'heal', name: 'ç‡Ÿé¤Šåˆé¤', desc: 'å›å¾© 30% ç”Ÿå‘½å€¼', type: 'heal' },
            { id: 'slow', name: 'æ™‚é–“å‡çµ', desc: 'æ•µäººç§»å‹•é€Ÿåº¦é™ä½ 20%', type: 'stat', stat: 'speedMult', val: 0.8 },
            { id: 'score', name: 'æ¦®è­½å¡', desc: 'åˆ†æ•¸ç²å–å¢åŠ  50%', type: 'stat', stat: 'scoreMult', val: 0.5 },
            { id: 'maxhp', name: 'é«”è‚²é›éŠ', desc: 'æœ€å¤§ç”Ÿå‘½å€¼å¢åŠ  20', type: 'maxhp', val: 20 },
            { id: 'shield', name: 'è­¦è¡›é˜²è­·', desc: 'ç²å¾—ä¸€æ¬¡å‚·å®³å…ç–«ç›¾', type: 'shield' }
        ];

        let canvas, ctx;
        let animationId;
        let lastTime = 0;
        
        let gameState = {
            status: 'START',
            currentStageIdx: 0,
            score: 0,
            enemies: [],
            particles: [],
            projectiles: [],
            spawnTimer: 0,
            killsInStage: 0,
            
            // Player Stats
            hp: 100,
            maxHp: 100,
            scoreMult: 1.0,
            speedMult: 1.0,
            shield: false
        };

        // --- Init ---
        window.onload = () => {
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('keydown', handleInput);
        };

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('hud').classList.add('flex');
            
            resetGame();
            startStage(0);
            gameState.status = 'PLAYING';
            lastTime = performance.now();
            loop(lastTime);
        }

        function resetGame() {
            gameState = {
                status: 'START',
                currentStageIdx: 0,
                score: 0,
                enemies: [],
                particles: [],
                projectiles: [],
                spawnTimer: 0,
                killsInStage: 0,
                hp: 100,
                maxHp: 100,
                scoreMult: 1.0,
                speedMult: 1.0,
                shield: false
            };
            updateHUD();
        }

        function startStage(idx) {
            gameState.currentStageIdx = idx;
            gameState.killsInStage = 0;
            gameState.enemies = [];
            gameState.projectiles = [];
            
            const stage = LEVELS[idx];
            document.getElementById('stage-name').innerText = stage.name;
            document.getElementById('stage-name').style.color = stage.color;
            
            // Show stage title briefly
            createFloatingText(canvas.width/2, canvas.height/2, stage.name, stage.color, 40);
        }

        // --- Game Loop ---
        function loop(timestamp) {
            if (gameState.status !== 'PLAYING') return;
            
            const dt = timestamp - lastTime;
            lastTime = timestamp;

            update(dt);
            draw();

            animationId = requestAnimationFrame(loop);
        }

        // --- Update Logic ---
        function update(dt) {
            const stage = LEVELS[gameState.currentStageIdx];

            // Spawning
            gameState.spawnTimer -= dt;
            if (gameState.spawnTimer <= 0) {
                spawnEnemy(stage);
                let ramp = Math.min(0.5, gameState.killsInStage / 50); 
                gameState.spawnTimer = stage.spawnRate * (1 - ramp); 
            }

            // Update Enemies
            for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                let e = gameState.enemies[i];
                e.y += e.speed * gameState.speedMult * (dt / 16);

                // Hit Floor
                if (e.y > canvas.height) {
                    takeDamage(15); // Floor damage
                    gameState.enemies.splice(i, 1);
                    shakeScreen();
                }
            }

            // Update Projectiles
            for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
                let p = gameState.projectiles[i];
                p.x = lerp(p.x, p.targetX, 0.25); // Faster projectiles
                p.y = lerp(p.y, p.targetY, 0.25);
                
                if (Math.abs(p.x - p.targetX) < 10 && Math.abs(p.y - p.targetY) < 10) {
                    createParticles(p.targetX, p.targetY, LEVELS[gameState.currentStageIdx].color);
                    gameState.projectiles.splice(i, 1);
                }
            }

            // Update Particles
            for (let i = gameState.particles.length - 1; i >= 0; i--) {
                let p = gameState.particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= dt;
                if (p.life <= 0) gameState.particles.splice(i, 1);
            }

            // Check Stage Clear
            if (gameState.killsInStage >= stage.targetKills && gameState.enemies.length === 0) {
                if (gameState.currentStageIdx >= LEVELS.length - 1) {
                    victory();
                } else {
                    levelComplete();
                }
            }
        }

        function spawnEnemy(stage) {
            const char = stage.chars.charAt(Math.floor(Math.random() * stage.chars.length));
            const x = Math.random() * (canvas.width - 100) + 50;
            gameState.enemies.push({
                char: char,
                x: x,
                y: -50,
                speed: stage.enemySpeedBase + (Math.random() * 0.5),
                id: Math.random()
            });
        }

        function handleInput(e) {
            if (gameState.status !== 'PLAYING') return;
            
            // Ignore non-character keys (like shift, ctrl) to prevent accidental damage
            if (e.key.length > 1) return;

            const key = e.key.toUpperCase();
            
            // Find target (lowest enemy with matching key)
            let targetIdx = -1;
            let maxY = -1000;

            gameState.enemies.forEach((enemy, idx) => {
                if (enemy.char === key) {
                    if (enemy.y > maxY) {
                        maxY = enemy.y;
                        targetIdx = idx;
                    }
                }
            });

            if (targetIdx !== -1) {
                // HIT
                const enemy = gameState.enemies[targetIdx];
                shootProjectile(enemy.x, enemy.y);
                gameState.enemies.splice(targetIdx, 1);
                gameState.score += Math.ceil(100 * gameState.scoreMult);
                gameState.killsInStage++;
                playSound('shoot');
                updateHUD();
            } else {
                // MISS (Penalty Added)
                takeDamage(5); // Deduct 5 HP for wrong key
                playSound('miss');
                createFloatingText(canvas.width/2, canvas.height/2 + 100, "MISS! -5", "#ff0000", 30, true);
                shakeScreen();
            }
        }

        function shootProjectile(tx, ty) {
            gameState.projectiles.push({
                x: canvas.width / 2,
                y: canvas.height,
                targetX: tx,
                targetY: ty
            });
        }

        function takeDamage(amount) {
            // Shield Logic
            if (gameState.shield && amount > 5) { // Only use shield for big damage (floor hits), not typos
                gameState.shield = false;
                playSound('powerup');
                createFloatingText(canvas.width/2, canvas.height/2, "SHIELD BLOCKED!", "#60a5fa", 30);
                return;
            } else if (gameState.shield && amount <= 5) {
                 // Shield doesn't block typos, but visual feedback is different
            }

            if (amount > 5) playSound('damage'); // Only play heavy damage sound for floor hits

            gameState.hp -= amount;
            if (gameState.hp <= 0) {
                gameState.hp = 0;
                gameOver();
            }
            updateHUD();
        }

        // --- Roguelike Systems ---

        function levelComplete() {
            gameState.status = 'UPGRADE';
            playSound('powerup');
            
            const notify = document.getElementById('level-notify');
            notify.classList.remove('hidden');
            
            setTimeout(() => {
                notify.classList.add('hidden');
                showUpgradeMenu();
            }, 2000);
        }

        function showUpgradeMenu() {
            const menu = document.getElementById('upgrade-menu');
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            menu.classList.remove('hidden');
            menu.classList.add('flex');

            const choices = [];
            const pool = [...BUFFS];
            for(let i=0; i<3; i++) {
                if (pool.length === 0) break;
                const idx = Math.floor(Math.random() * pool.length);
                choices.push(pool[idx]);
                pool.splice(idx, 1);
            }

            choices.forEach(buff => {
                const el = document.createElement('div');
                el.className = "card border-2 border-gray-600 p-6 rounded-lg w-full md:w-64 flex flex-col items-center text-center relative overflow-hidden group";
                el.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent group-hover:from-yellow-900/50 transition-all"></div>
                    <div class="text-5xl mb-4 text-yellow-400 relative z-10 group-hover:scale-110 transition-transform">âœ¦</div>
                    <h3 class="text-xl font-bold text-white mb-2 pixel-font relative z-10">${buff.name}</h3>
                    <p class="text-sm text-gray-300 relative z-10">${buff.desc}</p>
                `;
                el.onclick = () => selectBuff(buff);
                container.appendChild(el);
            });
        }

        function selectBuff(buff) {
            playSound('powerup');
            
            if (buff.type === 'heal') {
                gameState.hp = Math.min(gameState.hp + (gameState.maxHp * 0.3), gameState.maxHp);
            } else if (buff.type === 'stat') {
                gameState[buff.stat] = buff.id === 'slow' ? gameState[buff.stat] * buff.val : gameState[buff.stat] + buff.val;
            } else if (buff.type === 'maxhp') {
                gameState.maxHp += buff.val;
                gameState.hp += buff.val;
            } else if (buff.type === 'shield') {
                gameState.shield = true;
            }

            document.getElementById('upgrade-menu').classList.add('hidden');
            startStage(gameState.currentStageIdx + 1);
            gameState.status = 'PLAYING';
            updateHUD();
            
            lastTime = performance.now();
            requestAnimationFrame(loop);
        }

        // --- Drawing ---
        function draw() {
            ctx.fillStyle = 'rgba(15, 23, 42, 0.4)'; // Dark blue trail
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const stage = LEVELS[gameState.currentStageIdx];

            // Draw Enemies (Styled as falling blocks/runes)
            ctx.font = "bold 32px 'Noto Sans TC'";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            gameState.enemies.forEach(e => {
                // Glow effect
                ctx.shadowBlur = 15;
                ctx.shadowColor = stage.color;
                
                // Background shape
                ctx.fillStyle = "#1e293b";
                ctx.beginPath();
                ctx.roundRect(e.x - 25, e.y - 25, 50, 50, 10);
                ctx.fill();
                
                // Border
                ctx.lineWidth = 3;
                ctx.strokeStyle = stage.color;
                ctx.stroke();

                // Text
                ctx.fillStyle = "#ffffff";
                ctx.fillText(e.char, e.x, e.y + 2);
                
                ctx.shadowBlur = 0;
            });

            // Draw Projectiles
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#fbbf24";
            ctx.fillStyle = "#fbbf24";
            gameState.projectiles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Draw Particles
            gameState.particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 500;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            });
        }

        // --- Helpers ---
        function createParticles(x, y, color) {
            for (let i = 0; i < 12; i++) {
                gameState.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    life: 500,
                    color: color,
                    size: Math.random() * 5 + 2
                });
            }
        }

        function createFloatingText(x, y, text, color, size, isDamage = false) {
            const el = document.createElement('div');
            el.innerText = text;
            el.className = isDamage ? 'damage-text pixel-font' : 'pixel-font';
            if (!isDamage) {
                el.style.position = 'absolute';
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.color = color;
                el.style.fontSize = size + 'px';
                el.style.fontWeight = 'bold';
                el.style.textShadow = '0 0 10px black';
                el.style.transition = 'all 1s ease-out';
            } else {
                 el.style.left = x + 'px';
                 el.style.top = y + 'px';
            }
            
            document.body.appendChild(el);

            if (!isDamage) {
                setTimeout(() => {
                    el.style.opacity = 0;
                    el.style.top = (y - 50) + 'px';
                }, 50);
            }

            setTimeout(() => el.remove(), 1000);
        }

        function updateHUD() {
            const hpPercent = (gameState.hp / gameState.maxHp) * 100;
            const bar = document.getElementById('hp-bar');
            bar.style.width = hpPercent + '%';
            document.getElementById('hp-text').innerText = `${Math.ceil(gameState.hp)}/${gameState.maxHp}`;
            
            if (gameState.shield) {
                bar.parentElement.classList.add('ring-2', 'ring-blue-400');
            } else {
                bar.parentElement.classList.remove('ring-2', 'ring-blue-400');
            }

            const stage = LEVELS[gameState.currentStageIdx];
            // Fix division by zero if starts empty
            const progress = stage.targetKills > 0 ? Math.min(100, Math.floor((gameState.killsInStage / stage.targetKills) * 100)) : 0;
            document.getElementById('progress-text').innerText = progress + '%';
            document.getElementById('score-display').innerText = gameState.score;
        }

        function shakeScreen() {
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
        }

        function gameOver() {
            gameState.status = 'GAMEOVER';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('game-over-screen').classList.add('flex');
            document.getElementById('final-score').innerText = gameState.score;
            document.getElementById('death-reason').innerText = `åœ¨ ${LEVELS[gameState.currentStageIdx].name} å¤±å®ˆäº†...`;
        }

        function victory() {
            gameState.status = 'VICTORY';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('victory-screen').classList.remove('hidden');
            document.getElementById('victory-screen').classList.add('flex');
            document.getElementById('victory-score').innerText = gameState.score;
        }

        function lerp(start, end, t) {
            return start * (1 - t) + end * t;
        }
    </script>
</body>
</html>
